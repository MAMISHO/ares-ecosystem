var npmlog=require("npmlog"),Eof=require("./eof"),novacom=require("./novacom");
(function(){var b=npmlog;b.heading="luna";b.level="http";var k={send:function(a,c,l,k,g){function n(e){f+=e;try{b.verbose("luna#send()","JSON line:",f),d=JSON.parse(f),f="",b.verbose("luna#send()","JSON object:",d),!1===d.returnValue?(h.destroy(),g(Error("luna-send command failed"+(d.errorText?" ("+d.errorText+")":"")))):k(d,function(a,e){b.verbose("luna#send()","err:",a,"value:",e);if(a||e)b.verbose("luna#send()","closing exec stream"),g(a,e)})}catch(a){}}var m=a&&a.session,h=new Eof,d;h.pause();
c=["luna:/",c.service,c.folder,c.method].join("/");b.verbose("luna#send()","calling:",c+" '"+JSON.stringify(l)+"'");a=a&&a.nReplies?"-n "+a.nReplies+" ":"-i ";m.run(m.getDevice().lunaSend+" "+a+c+" '"+JSON.stringify(l)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n)},process.stderr,function(a){a&&g(a)});var f=""}};"undefined"!==typeof module&&module.exports&&(module.exports=k)})();
