var fs=require("fs"),path=require("path"),util=require("util"),npmlog=require("npmlog"),async=require("async"),streamBuffers=require("stream-buffers"),crypto=require("crypto"),luna=require("./luna"),novacom=require("./novacom"),errMsgHndl=require("./error-handler");
(function(){var c=npmlog;c.heading="installer";c.level="warn";var r={log:c,install:function(a,e,g){if("function"!==typeof g)throw Error("Missing completion callback (next="+util.inspect(g)+")");var d=path.basename(e);if(d){var k="/media/developer/temp/"+d,m=new streamBuffers.ReadableStreamBuffer,p=new streamBuffers.WritableStreamBuffer,q=a.appId,b,f,l=200;c.info("installer#install():","installing "+e);m.pause();a=a||{};async.waterfall([function(h){a.nReplies=0;new novacom.Session(a.device,h)},function(h,
c){a.session=h;if(a.opkg&&"root"!=a.session.getDevice().username)return setImmediate(c,Error("opkg-install is only available for the device allowing root-connection"));var b="/bin/rm -rf /media/developer/temp/ && /bin/mkdir -p /media/developer/temp/";"root"===a.session.getDevice().username&&(b+=" && /bin/chmod 777 /media/developer/temp/");a.op=(h.target.files||"stream")+"Put";a.session.run(b,null,null,null,c)},function(h){console.log("Installing package "+e);var b=a.op;if("streamPut"===b)fs.readFile(e,
function(f,n){if(f)return h(f);m.put(n);c.verbose("installer#type:",b);a.session[b](k,m,h)});else if("sftpPut"===b)c.verbose("installer#type:",b),a.session[b](e,k,h);else return c.verbose("installer#type:","unknown files type for installation"),h(Error("unknown files type for installtaion"))},function(h){a.session.run("/bin/ls -l "+k,null,p,null,h)},function(a){c.verbose("installer#install():","ls -l:",p.getContents().toString());a()},function(a){var f=crypto.createHash("md5"),d=new Buffer(l),n=0;
async.waterfall([fs.lstat.bind(fs,e),function(a,b){a.size>l?n=a.size-l:(n=0,l=a.size);b()},fs.open.bind(fs,e,"r"),function(a,b){fs.read(a,d,0,l,n,function(a,h){f.update(d);b()})},function(){(b=f.digest("hex"))||c.warn("installer#install():","Failed to get md5sum from the ipk file");c.verbose("installer#install():","srcMd5:",b);a()}],function(b){a(b)})},function(b){function d(a){if(a=Buffer.isBuffer(a)?a.toString().trim():a.trim())f=a.split("-")[0].trim(),c.verbose("installer#install():","dstMd5:",
f);f||c.warn("installer#install():","Failed to get md5sum from the transmitted file");b()}var e="/usr/bin/tail -c "+l+" "+k+" | /usr/bin/md5sum";async.series([function(b){a.session.run(e,null,d,null,b)}],function(a){if(a)return b(a)})},function(a){if(b&&f){if(c.verbose("installer#install():","srcMd5:",b,", dstMd5:",f),b!==f)return a(Error("File transmission error, please try again."))}else c.warn("installer#install():","Cannot verify transmitted file");a()},function(b){function f(b){function c(a){a=
Buffer.isBuffer(a)?a.toString():a;console.log(a)}var h="/usr/bin/opkg install "+k,h=h.concat(a.opkg_param?" "+a.opkg_param:"");async.series([a.session.run.bind(a.session,h,null,c,c),a.session.run.bind(a.session,"/usr/sbin/ls-control scan-services ",null,null,c)],function(a){if(a)return b(a);b(null,null)})}function d(b){var f=a.session.getDevice(),h=f.lunaResult.install;luna.send(a,f.lunaAddr.install,"webos3"===f.type?{target:k,subscribe:!0}:{id:q,ipkUrl:k,subscribe:!0},function(a,b){c.verbose("installer#install():",
"lineObj: %j",a);var f=h.getResultValue(a);f.match(/FAILED/i)?(c.verbose("installer#install():","failure"),b(errMsgHndl.changeErrMsg(f))):f.match(/installed|^SUCCESS/i)?(c.verbose("installer#install():","success"),b(null,f)):(c.verbose("installer#install():","waiting"),b(null,null))},b)}op=a.opkg?f:d;op(b)},function(b,f){"function"===typeof b&&(f=b);a.session.run("/bin/rm -f "+k,null,null,null,f)},function(){a.session.end();a.session=null;g(null,{msg:"Success"})}],function(a){c.verbose("installer#waterfall callback err:",
a);g(a)})}else g(Error("Invalid package: '"+e+"'"))},remove:function(a,e,g){if("function"!==typeof g)throw Error("Missing completion callback (next="+util.inspect(g)+")");a=a||{};async.waterfall([function(c){a.nReplies=void 0;a.session=new novacom.Session(a.device,c)},function(c,e){a.session=c;if(a.opkg&&"root"!=a.session.getDevice().username)return setImmediate(e,Error("opkg-remove is only available for the device allowing root-connection"));setImmediate(e)},function(d){function g(c){function d(a){a=
Buffer.isBuffer(a)?a.toString():a;return c(Error(a))}var b="/usr/bin/opkg remove "+e,b=b.concat(a.opkg_param?" "+a.opkg_param:"");async.series([a.session.run.bind(a.session,b,null,function(a){a=Buffer.isBuffer(a)?a.toString():a;console.log(a);if(a.match(/No packages removed/g))return c(Error("[package Name: "+e+"] "+a))},d),a.session.run.bind(a.session,"/usr/sbin/ls-control scan-services ",null,null,d)],function(a){if(a)return c(a);c(null,{})})}function m(d){var g=a.session.getDevice(),b=g.lunaResult.remove,
f=0;luna.send(a,g.lunaAddr.remove,"webos3"===g.type?{subscribe:!0,packageName:e}:{id:e,subscribe:!0},function(a,d){c.verbose("installer#remove():","lineObj: %j",a);var g=b.getResultValue(a);g.match(/FAILED/i)?(c.verbose("installer#remove():","failure"),f++||d(Error(g))):g.match(/removed|^SUCCESS/i)?(c.verbose("installer#remove():","success"),d(null,{status:g})):(c.verbose("installer#remove():","waiting"),d())},d)}op=a.opkg?g:m;op(d)}],function(a,k){c.verbose("installer#remove():","err:",a,"result:",
k);a||(k.msg="Removed package "+e);g(a,k)})},list:function(a,e){if("function"!==typeof e)throw Error("Missing completion callback (next="+util.inspect(e)+")");a=a||{};async.waterfall([function(c){a.nReplies=1;a.session=new novacom.Session(a.device,c)},function(c,d){a.session=c;if(a.opkg&&"root"!=a.session.getDevice().username)return setImmediate(d,Error("opkg-list is only available for the device allowing root-connection"));setImmediate(d)},function(g){function d(c){function d(a){a=Buffer.isBuffer(a)?
a.toString():a;console.log(a)}var e;e="/usr/bin/opkg list".concat(a.opkg_param?" "+a.opkg_param:"");async.series([a.session.run.bind(a.session,e,null,d,d)],function(a){if(a)return c(a);c(null,{})})}function e(d){var g=a.session.getDevice().lunaAddr.list,k=a.session.getDevice().lunaResult.list,b;luna.send(a,g,{subscribe:!1},function(a,d){b=k.getResultValue(a);if(Array.isArray(b)){for(var e=0;e<b.length;e++)b[e].visible||(b.splice(e,1),e--);c.verbose("installer#list():","success");d(null,b)}else c.verbose("installer#list():",
"failure"),d(Error("object format error"))},d)}op=a.opkg?d:e;op(g)}],function(a,d){c.verbose("installer#list():","err:",a,"results:",d);e(a,d)})}};"undefined"!==typeof module&&module.exports&&(module.exports=r)})();
