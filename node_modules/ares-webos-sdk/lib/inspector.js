var util=require("util"),async=require("async"),path=require("path"),npmlog=require("npmlog"),request=require("request"),luna=require("./luna"),streamBuffers=require("stream-buffers"),spawn=require("child_process").spawn,fs=require("fs"),novacom=require("./novacom"),utility=require("./utility"),sdkenv=require("./sdkenv"),platformOpen={win32:["cmd","/c","start"],darwin:["open"],linux:["xdg-open"]},prefixPath="/media/developer/",defaultServiceInstallPath="apps/usr/palm/services/",defaultAppInsptPort=
"9998",defaultNodeInsptPort="8080",defaultServiceDebugPort="5885";
(function(){var e=npmlog;e.heading="inspector";e.level="warn";var p={log:e,inspect:function(a,p,l){function m(b,c){var h=util.format("netstat -ltn 2>/dev/null | grep :%s | wc -l",b);async.series([a.session.run.bind(a.session,h,process.stdin,function(a){a=Buffer.isBuffer(a)?a.toString().trim():a.trim();if("0"===a)c(null,b);else if("1"===a)b=Number(b)+1,m(b,c);else return c(Error("Failed to get Debug Port"))},process.stderr)],function(a,b){a&&c(a)})}if("function"!==typeof l)throw Error("Missing completion callback (next="+
util.inspect(l)+")");a.NumOfRunServer=0;a.serviceIds=[];a.svcDbgPorts=[];a&&a.hasOwnProperty("serviceId")&&(a.serviceId instanceof Array?a.serviceIds=a.serviceId:a.serviceIds.push(a.serviceId));async.series([function(b){(new sdkenv.Env).getEnvValue("BROWSER",function(c,h){a.bundledBrowserPath=h;b()})},function(b){a.nReplies=1;a.session=new novacom.Session(a.device,b)},function(b){a.appId?a.session.forward(defaultAppInsptPort,a.hostPort||0,a.appId,b):b()},function(b){async.series([async.forEachSeries.bind(this,
a.serviceIds,function(c,b){if(c){defaultServiceInstallPath=prefixPath+defaultServiceInstallPath;var d=defaultServiceDebugPort,f=path.join(defaultServiceInstallPath,c).replace(/\\/g,"/");async.waterfall([function(k){function b(a){n=Buffer.isBuffer(a)?a.toString().trim():a.trim();k(null,n)}var d="cat "+path.join(f,"services.json").replace(/\\/g,"/"),n;async.series([function(c){a.session.run(d,process.stdin,b,process.stderr,c)}],function(a,b){if(a)return k(Error("webOS Service named '"+c+"' was not installed"))})},
function(a,b){try{if("native"===JSON.parse(a).engine)return b(Error(c+" is a native service, please use ares-gdbserver to debug it."));b()}catch(d){b(d)}},function(b){a.nReplies=1;luna.send(a,{service:c,method:"quit"},{},function(a,c){b()},b)},function(b){a.session.runNoHangup("mkdir -p "+f+"/_ares",b)},m.bind(this,d),function(b,c){d=b;a.session.runNoHangup("echo "+d+" > "+f+"/_ares/debugger-port",c)},function(a){setTimeout(function(){a()},1E3)}.bind(this),function(b){a.svcDbgPorts.push({id:c,port:d});
if("root"==a.session.getDevice().username){var g=util.format("sh /usr/bin/run-js-service -d -p %s %s",d,path.join(defaultServiceInstallPath,c)),g=g.replace(/\\/g,"/");a.session.runNoHangup(g,b)}else a.nReplies=1,luna.send(a,{service:c,method:"info"},{},function(a,c){b()},b)}.bind(this),function(a){setTimeout(function(){a()},1E3)}.bind(this),a.session.forward.bind(a.session,defaultNodeInsptPort,a.hostPort||0,c),function(b){a.session.runNoHangup("rm -rf "+f+"/_ares",b)}],function(a,c){e.verbose("inspector#inspect()",
"err: ",a,"results:",c);b(a,c)})}else b()}.bind(this))],function(a){a&&b(a);b()})},function(b){if(a.appId){var c="http://localhost:"+a.session.getLocalPortByName(a.appId),h;a.session.target.noPortForwarding&&(e.verbose("inspector#inspect()","noPortForwarding"),c="http://"+a.session.ssh._host+":9998");request.get(c+"/pagelist.json",function(b,f,e){if(!b&&200==f.statusCode){b=JSON.parse(e);for(var g in b)if(-1!=b[g].url.indexOf(a.appId)||-1!=b[g].url.indexOf(a.localIP))c+=b[g].inspectorUrl;console.log("Application Debugging - "+
c)}utility.runServer(__dirname,0,function(a,b){"@@ARES_CLOSE@@"===a?(b.status(200).send(),h=setTimeout(function(){process.exit(0)},2E3)):"@@GET_URL@@"===a&&(clearTimeout(h),b.status(200).send(c))},function(b,c){b?process.exit(1):c&&c.msg&&a.open&&utility.openBrowser("http://localhost:"+c.port+"/ares_cli/ares.html",a.bundledBrowserPath)})})}b()},function(b){async.series([async.forEachSeries.bind(this,a.svcDbgPorts,function(b,e){var d,f=a.session.getLocalPortByName(b.id),k;d=util.format("http://%s:%s/debug?port=%s",
"localhost",f,b.port);request.get(d,function(b,c,e){b||200!=c.statusCode||(console.log("nodeInsptUrl:",d),utility.runServer(__dirname,0,function(a,b){"@@ARES_CLOSE@@"===a?(b.status(200).send(),k=setTimeout(function(){process.exit(0)},2E3)):"@@GET_URL@@"===a&&(clearTimeout(k),b.status(200).send(d))},function(b,c){b?process.exit(1):c&&c.msg&&a.open&&utility.openBrowser("http://localhost:"+c.port+"/ares_cli/ares.html",a.bundledBrowserPath)}))});e()}.bind(this))],function(a){a&&b(a);b()})},function(a){e.verbose("inspector#inspect()",
"running...")}],function(a,c){e.verbose("inspector#inspect()","err: ",a,"results:",c);l(a,c[1])})}};"undefined"!==typeof module&&module.exports&&(module.exports=p)})();
