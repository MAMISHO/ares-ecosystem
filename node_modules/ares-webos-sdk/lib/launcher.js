var util=require("util"),async=require("async"),npmlog=require("npmlog"),luna=require("./luna"),path=require("path"),inspector=require("./inspector"),installer=require("./installer"),novacom=require("./novacom"),os=require("os");
(function(){var d=npmlog;d.heading="launcher";d.level="warn";var m={log:d,launch:function(a,k,e,h){if("function"!==typeof h)throw Error("Missing completion callback (next="+util.inspect(h)+")");var c=!1,l=this;a=a||{};async.series([function(b){"Hosted"===a.installMode?installer.list(a,function(a,f){for(index in f)if("com.sdk.ares.hostedapp"===f[index].id){c=!0;break}b()}):b()},function(b){"Hosted"===a.installMode?l.listRunningApp(a,null,function(g,f){for(index in f)if("com.sdk.ares.hostedapp"===f[index].id){l.close(a,
"com.sdk.ares.hostedapp",null,b);return}b()}):b()},function(b){if("Hosted"!==a.installMode||c)b();else{var g=path.join(__dirname,"com.sdk.ares.hostedapp.ipk");a.appId=k;installer.install(a,g,b)}},function(b){a.nReplies=1;a.session=new novacom.Session(a.device,b)},function(b){"Hosted"===a.installMode?(a.session.runHostedAppServer(a.hostedurl,b),console.log("Ares Hosted App is now running...")):b()},function(b){if("Hosted"===a.installMode){var g=os.networkInterfaces(),f="";for(devName in g)for(var c=
0;c<g[devName].length;c++){var d=g[devName][c];"IPv4"!==d.family||"127.0.0.1"===d.address||d.internal||(f=f||d.address,a.localIP=f)}g=a.session.getHostedAppServerPort();null==e&&(e={});e.hostedurl="http://"+f+":"+g+"/"}b()},function(b){var c=a.session.getDevice(),f=c.lunaResult.launch;luna.send(a,c.lunaAddr.launch,{id:k,subscribe:!1,params:e},function(a,b){d.silly("launcher#launch#_launch():","lineObj:",a);var c=f.getResultValue(a);c?(d.verbose("launcher#launch#_launch():","success"),b(null,{procId:c})):
(d.verbose("launcher#launch#_launch():","failure"),b(Error("object format error")))},b)},function(b){a.inspect?(a.appId=k,inspector.inspect(a,null,b)):"Hosted"!=a.installMode&&b()}],function(a,c){d.verbose("launcher#launch()","err: ",a,"results:",c);var f=c[6];a||(f.msg="Launched application "+k);h(a,f)})},close:function(a,k,e,h){if("function"!==typeof h)throw Error("Missing completion callback (next="+util.inspect(h)+")");a=a||{};async.series([function(c){a.nReplies=1;a.session=new novacom.Session(a.device,
c)},function(c){var h=a.session.getDevice(),b=h.lunaAddr.terminate,g=h.lunaResult.terminate;"webos3"===h.type?c():luna.send(a,b,{id:k,subscribe:!1},function(a,b){d.silly("launcher#close#_close():","lineObj:",a);var c=g.getResultValue(a);c?(d.verbose("launcher#close#_close():","success"),b(null,{procId:c})):(d.verbose("launcher#close#_close():","failure"),b(Error("object format error")))},c)}],function(a,e){d.verbose("launcher#close()","err: ",a,"results:",e);var b=e[1];!a&&b&&(b.msg="Closed application "+
k);h(a,b)})},listRunningApp:function(a,k,e){if("function"!==typeof e)throw Error("Missing completion callback (next="+util.inspect(e)+")");a=a||{};async.waterfall([function(d){a.nReplies=1;a.session=new novacom.Session(a.device,d)},function(h,c){var e=a.session.getDevice(),b=e.lunaAddr.running,g=e.lunaResult.running;if(!b||!g)return c(Error("not supported method to get running app information"));luna.send(a,b,{subscribe:!1},function(a,b){resultValue=g.getResultValue(a);Array.isArray(resultValue)?
(d.verbose("launcher#listRunningApp():","success"),b(null,resultValue)):(d.verbose("launcher#listRunningApp():","failure"),b(Error("object format error")))},c)}],function(a,c){d.verbose("launcher#listRunningApp():","err:",a,"results:",c);e(a,c)})}};"undefined"!==typeof module&&module.exports&&(module.exports=m)})();
