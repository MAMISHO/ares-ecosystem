var fs=require("fs"),path=require("path"),util=require("util"),stream=require("stream"),net=require("net"),mkdirp=require("mkdirp"),async=require("async"),log=require("npmlog"),ssh2=require("ssh2"),shelljs=require("shelljs"),express=require("express"),http=require("http"),mkdirp=require("mkdirp"),request=require("request"),utility=require("./utility"),Validator=require("jsonschema").Validator,errMsgHndl=require("./error-handler");
(function(){function p(a,c,b){var d=null;if(0!==c||b)d=Error("Command '"+a+"' exited with code="+c+" (signal: "+b+")"),d.code=c,d.signal=b;return d}function t(){this.devices=[];this.deviceFileContent=null}var m={};"undefined"!==typeof module&&module.exports&&(module.exports=m);log.heading="novacom";log.level="warn";m.log=log;var l=path.resolve(process.env.HOME||process.env.USERPROFILE,".ssh"),q=path.resolve(process.env.APPDATA||process.env.HOME||process.env.USERPROFILE,".ares"),r={webos3:{lunaSend:"/usr/bin/luna-send",
lunaAddr:{install:{service:"com.palm.appinstaller",method:"installNoVerify"},remove:{service:"com.palm.appinstaller",method:"remove"},list:{service:"com.palm.applicationManager",method:"listPackages"},launch:{service:"com.palm.applicationManager",method:"launch"}},lunaResult:{install:{getResultValue:function(a){return a.status}},remove:{getResultValue:function(a){return a.status}},list:{getResultValue:function(a){return a.packages}},launch:{getResultValue:function(a){return a.processId}}}},webospro:{lunaSend:"/usr/bin/luna-send",
lunaAddr:{install:{service:"com.webos.appInstallService",method:"installLocalNoVerify"},remove:{service:"com.webos.appInstallService",method:"remove"},list:{service:"com.webos.applicationManager",method:"listApps"},launch:{service:"com.webos.applicationManager",method:"launch"},terminate:{service:"com.webos.applicationManager",method:"closeByAppId"},running:{service:"com.webos.applicationManager",method:"running"}},lunaResult:{install:{getResultValue:function(a){return a.details.state}},remove:{getResultValue:function(a){return a.details.state}},
list:{getResultValue:function(a){return a.apps}},launch:{getResultValue:function(a){return a.processId}},terminate:{getResultValue:function(a){return a.returnValue}},running:{getResultValue:function(a){return a.running}}}},starfish:{lunaSend:"/usr/bin/luna-send-pub",lunaAddr:{install:{service:"com.webos.appInstallService",folder:"dev",method:"install"},remove:{service:"com.webos.appInstallService",folder:"dev",method:"remove"},list:{service:"com.webos.applicationManager",folder:"dev",method:"listApps"},
launch:{service:"com.webos.applicationManager",method:"launch"},terminate:{service:"com.webos.applicationManager",folder:"dev",method:"closeByAppId"},running:{service:"com.webos.applicationManager",folder:"dev",method:"running"}},lunaResult:{install:{getResultValue:function(a){return a.details.state}},remove:{getResultValue:function(a){return a.details.state}},list:{getResultValue:function(a){return a.apps}},launch:{getResultValue:function(a){return a.processId}},terminate:{getResultValue:function(a){return a.returnValue}},
running:{getResultValue:function(a){return a.running}}}}};m.Resolver=t;m.Resolver.prototype={load:function(a){function c(a,b,d){log.verbose("Resolver#load#_replaceDeviceFile()","buildtin:",a,",dstPath:",b);var e=path.dirname(b);fs.stat(b,function(n,s){if(n)if("ENOENT"===n.code)async.series([mkdirp.bind(this,e),function(c){log.verbose("Resolver#_load#_checkFile() file copied from ",a," to ",b);shelljs.cp("-rf",a,e);setImmediate(c)}.bind(this)],function(a){if(a)return setImmediate(d,a);setImmediate(d,
null,b)});else return setImmediate(d,n);else fs.stat(a,function(e,g){if(e)return setImmediate(d,e);s.mtime.getTime()<g.mtime.getTime()?(shelljs.rm("-rf",b),c(a,b,d)):setImmediate(d,null,b)}.bind(this))}.bind(this))}var b=this,d=path.join(__dirname,"novacom-devices.json"),e=path.join(q,"novacom-devices.json");log.verbose("Resolver#load()");async.waterfall([function(a){log.verbose("Resolver#load#_replaceBuiltinSshKey()");var b=path.join(__dirname,"webos_emul"),c=path.join(l,"webos_emul");fs.stat(b,
function(d,e){d?"ENOENT"===d.code?setImmediate(a):setImmediate(a,d):fs.stat(c,function(d,g){d?"ENOENT"===d.code?mkdirp(l,function(d){shelljs.cp("-rf",b,l);fs.chmodSync(c,"0600");setImmediate(a)}):setImmediate(a,d):(e.mtime.getTime()>g.mtime.getTime()&&(shelljs.cp("-rf",b,l),fs.chmodSync(c,"0600")),setImmediate(a))}.bind(this))}.bind(this))}.bind(b),c.bind(b,d,e),function(a,b){log.verbose("Resolver#load#_readFile()","<<< "+a);fs.readFile(a,"utf8",function(a,d){a&&"ENOENT"===a.code?setImmediate(b,null,
"[]"):setImmediate(b,a,d)})}.bind(b),function(a,d){log.silly("Resolver#load#_loadString()","str:",a);this.deviceFileContent=a;var c=JSON.parse(a);Array.isArray(c)?(log.silly("Resolver#load#_loadString()","inDevices:",c),async.forEach(c,function(a,d){async.series([b._loadOne.bind(b,a),b._addOne.bind(b,a)],d)},function(a,c){a?setImmdiate(d,a):(log.verbose("Resolver#load#_loadString()","devices:",b.devices),setImmediate(d))})):setImmediate(d,Error("Incorrect file format'"))}.bind(b)],function(d){d?setImmediate(a,
d):(log.info("Resolver#load()","devices:",b.devices),setImmediate(a))})},_save:function(a){var c=path.join(q,"novacom-devices.json"),b=this.devices.filter(function(a){return a.privateKey});log.verbose("Resolver#_save()",">>> "+c);async.series([mkdirp.bind(this,q),fs.writeFile.bind(this,c,JSON.stringify(b,function(a,b){return"display"===a||"lunaAddr"===a||"lunaResult"===a?void 0:"privateKey"===a&&"string"!==typeof b&&b instanceof Buffer?b.toString("base64"):b},2))],a)},add:function(a,c){log.verbose("Resolver#add()",
"deviceInfo:",a);var b={name:a.name.toLowerCase().replace(/ +/g,"_"),description:a.description||a.name,host:a.host||"127.0.0.1",port:a.port||6622,username:a.username||"root",type:a.type||"starfish"};async.series([this._loadOne.bind(this,b),this._addOne.bind(this,b),this._save.bind(this),function(a){log.info("Resolver#add()","added device:",b.display)}],c)},_loadOne:function(a,c){log.silly("Resolver#_loadOne()","device:",a);"string"===typeof a.privateKey?(a.privateKeyName=a.privateKey,a.privateKey=
new Buffer(a.privateKey,"base64"),setImmediate(c)):"object"===typeof a.privateKey&&"string"===typeof a.privateKey.openSsh?(a.privateKeyName=a.privateKey.openSsh,async.waterfall([fs.readFile.bind(this,path.join(l,a.privateKey.openSsh),c),function(b,c){a.privateKey=b;setImmediate(c)}],function(b){b&&(log.verbose("Resolver#_loadOne()","Unable to find SSH private key named '"+a.privateKey.openSsh+"' from '"+l+" for '"+a.name+"'"),a.privateKey=void 0);setImmediate(c)})):"webospro"===typeof a.type?setImmediate(c,
Error("Not implemented: go & grab the webOS Pro private key here")):(a.password||log.verbose("Resolver#_loadOne()","Regist privateKey : need to set a SSH private key in "+l+" for'"+a.name+"'"),a.privateKeyName=void 0,a.privateKey=void 0,setImmediate(c))},_addOne:function(a,c){a.display={name:a.name,type:a.type,privateKeyName:a.privateKeyName,passphase:a.passphase,description:a.description};a.username&&a.host&&a.port&&(a.display.addr="ssh://"+a.username+"@"+a.host+":"+a.port);for(var b in a)"display"!==
b&&(a.display[b]=a[b]);log.silly("Resolver#_addOne()","device:",a);this.devices=this.devices.filter(function(b){return b.name!==a.name});a.lunaSend=r[a.type].lunaSend;a.lunaAddr=r[a.type].lunaAddr;a.lunaResult=r[a.type].lunaResult;this.devices.push(a);setImmediate(c)},remove:function(a,c){log.verbose("Resolver#remove()","deviceName:",a);this.devices=this.devices.filter(function(b){return b.name!==a});this._save(c)},save:function(a,c){function b(a,b){log.verbose("Resolver#save()#_checkValidNovacomDevices()",
"devices:",a);var c={id:"test",type:"array",items:{$ref:"/deviceSchema"}},d=path.join(__dirname,"NovacomDevices.schema");if(fs.statSync(d).isFile()){var d=fs.readFileSync(d,"utf8"),g=new Validator;try{var n=JSON.parse(d);g.addSchema(n,"/deviceSchema");b(null,g.validate(a,c))}catch(s){b(Error("Invalid JSON Schema"))}}else log.verbose("Resolver#save()#_checkValidNovacomDevices()","No schema for novacom-devices.json"),b()}log.verbose("Resolver#save()","devicesData:",a);var d=path.join(q,"novacom-devices.json");
fs.exists(d,function(e){e||(d=path.join(__dirname,"novacom-devices.json"));async.waterfall([b.bind(this,a)],function(b,e){if(b)return c(b);if(e&&0<e.errors.length){var h;h="".concat("Invalid device info.");for(idx in e.errors){h=h.concat("\n");var g=e.errors[idx].property+" "+e.errors[idx].message;null!=(e=/instance\[*.*\]*\./g.exec(g))&&(g=g.substring(e[0].length));h=h.concat(g)}return setImmediate(c,Error(h))}log.verbose("Device Info is valid");fs.writeFile(d,JSON.stringify(a,null,"\t"),c)})})},
list:function(a){log.verbose("Resolver#list()");setImmediate(a,null,this.devices.map(function(a){return a.display}))},getRawDeviceString:function(a){log.verbose("Resolver#getRawDeviceString()");setImmediate(a,null,this.deviceFileContent)},getDeviceBy:function(a,c,b){log.verbose("Resolver#getDeviceBy()","key:",a,"value:",c);var d=new RegExp(c,"gi"),e=[],f=this.devices.filter(function(b){return b[a]&&b[a].match(d)});1<f.length&&(e=f.filter(function(b){return b[a]&&b[a]===c}));log.verbose("Resolver#getDeviceBy()",
"devices:",f);if("function"===typeof b)log.silly("Resolver#getDeviceBy()","async"),1===f.length?setImmediate(b,null,f[0]):1<f.length?1===e.length?setImmediate(b,null,e[0]):(e=f.map(function(a){return a.name}),setImmediate(b,Error("Multiple devices("+e.join()+") matching '"+a+"'='"+c+"'"))):setImmediate(b,Error("No device matching '"+a+"'='"+c+"'"));else return log.silly("Resolver#getDeviceBy()","sync"),e[0]||f[0]},getSshPrvKey:function(a,c){var b="string"===typeof a?a:a&&a.name;b?async.waterfall([this.getDeviceBy.bind(this,
"name",b),function(a,b){log.info("Resolver#getSshPrvKey()","target.host:",a.host);var c="http://"+a.host+":9991/webos_rsa",k=a.name.replace(/(\s+)/gi,"_")+"_webos",h=path.join(l,k);request.head(c,function(a,d,s){if(a||d&&200!==d.statusCode)return setImmediate(b,Error("Failed to get ssh private key"));log.info("Resolver#getSshPrvKey()#head","content-type:",d.headers["content-type"]);log.info("Resolver#getSshPrvKey()#head","content-length:",d.headers["content-length"]);request(c).pipe(fs.createWriteStream(h)).on("close",
function(a){if(a)return setImmediate(b,Error("Failed to get ssh private key"));setImmediate(b,a,h,k)})})},function(a,b,c){log.info("Resolver#getSshPrvKey()","SSH Private Key:",a);console.log("SSH Private Key:",a);fs.chmodSync(a,"0600");setImmediate(c,null,b)}],c):setImmediate(c,Error("Need to select a device name to get Ssh Private Key"))},modifyDeviceFile:function(a,c,b){if(c.name)if(this.deviceFileContent){var d=JSON.parse(this.deviceFileContent);if(Array.isArray(d)){if("add"==a){a=-1;for(idx in d){if(d[idx].name===
c.name){setImmediate(b,Error("Existing Target Name"));return}d[idx].order>a&&(a=d[idx].order)}-1!=a&&(c.order=++a);for(key in c)"@DELETE@"===c[key]&&delete c[key];d=d.concat(c)}else if("remove"==a){a=-1;for(idx in d)if(d[idx].name===c.name){a=d[idx].order||-1;break}if(-1!==idx){if(d[idx].name!==c.name)return setImmediate(b,Error("Please enter a correct device name!!"));if(d[idx].indelible&&!0===d[idx].indelible)return setImmediate(b,Error("this device should not be removed!!"));d.splice(idx,1);for(idx in d)d[idx].order>
a&&d[idx].order--}}else if("modify"==a){var e=!1;d.forEach(function(a){a.name===c.name&&(e=!0,Object.keys(c).forEach(function(b){"@DELETE@"===c[b]?delete a[b]:a[b]=c[b]}))});if(!1===e)return setImmediate(b,Error("Could not find a device named "+c.name))}else return setImmediate(b,Error("Unknown operator"));this.save(d,b)}else setImmediate(b,Error("Incorrect file format'"))}else setImmediate(b,Error("Need to load file"));else setImmediate(b,Error("Incorrect target name"))}};m.Session=function(a,c){if("function"!==
typeof c)throw Error("novacom.Session(): BUG next must be a common-js callback");var b=("string"===typeof a?a:a&&a.name)||"emulator";log.info("novacom.Session()","opening session to '"+b+"'");this.resolver=new t;async.waterfall([this.resolver.load.bind(this.resolver),this.resolver.getDeviceBy.bind(this.resolver,"name",b),this.checkConnection.bind(this),this.begin.bind(this)],c)};m.Session.prototype={checkConnection:function(a,c){var b=!1;if(a&&a.host&&a.port){var d=new net.Socket;d.setTimeout(2E3);
var e=d.connect({host:a.host,port:a.port});e.on("connect",function(){b=!0;e.end();setImmediate(c,null,a)});e.on("error",function(a){e.destroy();setImmediate(c,errMsgHndl.changeErrMsg(a))});e.on("timeout",function(a){e.destroy();b||setImmediate(c,errMsgHndl.changeErrMsg("Time out"))})}else setImmediate(c,null,a)},begin:function(a,c){function b(a){setImmediate(c,errMsgHndl.changeErrMsg(a),this)}function d(){log.verbose("Clear Session");e.end();setTimeout(function(){process.exit()},500)}log.verbose("Session#begin()",
"target:",a);var e=this;this.target=a||this.target;if(!typeof this.target.privateKey&&!typeof this.target.password)return setImmediate(c,Error("Private Key File or Password does not exist!!"));this.ssh||(this.forwardedPorts=[],this.ssh=new ssh2,this.ssh.on("connect",function(){log.verbose("Session#begin()","ssh session event: connected")}),this.ssh.on("ready",b.bind(this)),this.ssh.on("error",b.bind(this)),this.ssh.on("end",function(){log.verbose("Session#begin()","ssh session event: end")}),this.ssh.on("close",
function(a){log.verbose("Session#begin()","ssh session event: close  (had_error:",a,")")}),this.target.readyTimeout=3E4,this.ssh.connect(this.target),process.on("SIGHUP",d),process.on("SIGINT",d),process.on("SIGQUIT",d),process.on("SIGTERM",d),process.on("exit",function(a){d()}));return this},getDevice:function(){return this.target},end:function(){log.verbose("Session#end()","user-requested termination");this.ssh&&(this.ssh.end(),this.ssh=null);return this},streamPut:function(a,c,b){log.verbose("Session#streamPut()",
"streaming into device:"+a);this.run("/bin/cat > "+a,c,null,process.stderr,b)},sftpPut:function(a,c,b){log.verbose("Session#sftpPut()","streaming into device:",c,"from host:",a);this.ssh.sftp(function(d,e){if(d)setImmediate(b,d);else{var f=fs.createReadStream(a),k=e.createWriteStream(c);k.on("close",function(){e.end();setImmediate(b)});k.on("exit",function(a,c){d=p("sftpPut",a,c);setImmediate(b,d)});k.on("error",function(a){log.verbose("Session#sftpPut()","error:",a);a=errMsgHndl.changeErrMsg("sftp fail");
setImmediate(b,a)});f.pipe(k)}})},streamGet:function(a,c,b){log.verbose("Session#streamGet()","streaming from device:"+a);this.run("/bin/cat "+a,null,c,process.stderr,b)},sftpGet:function(a,c,b){log.verbose("Session#sftpGet()","streaming into host:",c,"from target:",a);this.ssh.sftp(function(d,e){if(d)setImmediate(b,d);else{var f=e.createReadStream(a),k=fs.createWriteStream(c);f.on("close",function(){e.end();setImmediate(b)});f.on("exit",function(a,c){d=p("sftpGet",a,c);setImmediate(b,d)});f.pipe(k)}})},
run:function(a,c,b,d,e){log.verbose("Session#run()","cmd="+a);if("function"!==typeof e)throw Error("BUG: 'next' is not a callback");var f={},k={};b?b instanceof stream.Stream?(log.silly("Session#run()","stdout: stream"),f.stdout=b.write,k.stdout=b):b instanceof Function?(log.silly("Session#run()","stdout: function"),f.stdout=b):setImmediate(e,Error("Invalid novacom stdout: "+util.inspect(b))):(log.silly("Session#run()","stdout: none"),f.stdout=function(){});d?d instanceof stream.Stream?(log.silly("Session#run()",
"stderr: stream"),f.stderr=d.write,k.stderr=d):d instanceof Function?(log.silly("Session#run()","stderr: function"),f.stderr=d):setImmediate(e,Error("Invalid novacom stderr: "+util.inspect(d))):(log.silly("Session#run()","stderr: none"),f.stderr=function(){});this.ssh.exec(a,function(h,g){log.verbose("Session#run()","exec cmd: "+a+", err:"+h);h?setImmediate(e,h):(g.on("data",function(a,b){b=b||"stdout";log.verbose("Session#run()","on data ("+b+")");f[b].bind(k[b])(a)}),g.on("end",function(){log.verbose("Session#run()",
"event EOF from (cmd: "+a+")");b!==process.stdout&&b instanceof stream.Stream&&b.end();d!==process.stderr&&d instanceof stream.Stream&&d.end()}),g.on("exit",function(b,c){log.verbose("Session#run()","event exit code="+b+", signal="+c+" (cmd: "+a+")");h=p(a,b,c);setImmediate(e,h)}),g.on("close",function(){log.verbose("Session#run()","event close  (cmd: "+a+")");void 0===h&&setImmediate(e)}),g.on("drain",function(){c&&c.resume()}),c&&(c.on("data",function(a){g.writable&&!0===g.writable&&!1===g.write(a)&&
(c.pause(),setTimeout(function(){c.resume();clearTimeout()},1E3))}),c.on("end",function(){g.end()}),log.verbose("Session#run()","resuming input"),c!==process.stdin&&c.resume()))}.bind(this))},runNoHangup:function(a,c,b,d){log.verbose("Session#runNoHangup()","cmd="+a);if(2>arguments.length)throw Error("BUG: 'next' is not a callback");switch(arguments.length){case 2:d=c;c=b=null;break;case 3:d=b,b=c,c=null}if("function"!==typeof d)throw Error("BUG: 'next' is not a callback");this.ssh.exec(a,function(e,
f){log.verbose("Session#run()","exec cmd: "+a+", err:"+e);if(e)setImmediate(d,e);else{f.on("data",function(a,b){var d=Buffer.isBuffer(a)?a.toString():a;log.verbose("[Session#runNoHangup()#onData]",d);c&&c(a)});if(b)f.on("exit",function(c,d){log.verbose("Session#runNoHangup()","event exit code="+c+", signal="+d+" (cmd: "+a+")");e=p(a,c,d);b(e)});setImmediate(d)}}.bind(this))},forward:function(a,c,b,d){log.verbose("Session#forward()","devicePort:",a,"localPort:",c);var e=this,f=!1,k=null;"function"===
typeof b?d=b:b&&(k=b);0!==c?0<e.forwardedPorts.indexOf({name:k,local:c,device:a})&&(f=!0):0<e.forwardedPorts.filter(function(b){return b.device===a&&b.name===k}).length&&(f=!0);if(f)setImmediate(d);else{var h=net.createServer(function(b){log.info("Session#forward()","new client, localPort:",c);log.verbose("Session#forward()","new client, from: "+b.remoteAddress+":"+b.remotePort);b.on("error",function(a){log.verbose("Session#forward()","inCnx::error, err:: "+a)});e.ssh.forwardOut("127.0.0.1",b.remotePort,
"127.0.0.1",a,function(d,e){d?(console.log("Session#forward()","failed forwarding client localPort:",c,"(inCnx.remotePort:",b.remotePort,")=> devicePort:",a),log.warn("Session#forward()","failed forwarding client localPort:",c,"=> devicePort:",a),b.destroy()):(log.info("Session#forward()","connected, devicePort:",a),b.on("data",function(a){e.writable&&!0===e.writable&&!1===e.write(a)&&b.pause()}),b.on("close",function(a){log.verbose("Session#forward()","inCnx::close, had_err:",a);e.destroy()}),e.on("drain",
function(){b.resume()}),e.on("data",function(a){b.write(a)}),e.on("error",function(a){log.verbose("Session#forward()","outCnx::error, err:: "+a)}),e.on("close",function(a){log.verbose("Session#forward()","outCnx::close, had_err:",a)}))})});try{var g;h.listen(c,null,function(){g=h.address().port;e.forwardedPorts.push({name:k,local:g,device:a});setImmediate(d)}.bind(this))}catch(l){setImmediate(d,l)}}},getLocalPortByDevicePort:function(a){var c=null;this.forwardedPorts.forEach(function(b){b.device===
a&&(c=b.local)});return c},getLocalPortByName:function(a){var c=null;this.forwardedPorts.forEach(function(b){b.name===a&&(c=b.local)});return c},runHostedAppServer:function(a,c){utility.runServer(a,0,function(a,d){d&&d.port&&this.setHostedAppServerPort(d.port);c(a)}.bind(this))},setHostedAppServerPort:function(a){this.hostedAppServerPort=a},getHostedAppServerPort:function(){return this.hostedAppServerPort}}})();
