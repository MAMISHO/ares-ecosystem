var fs=require("fs"),os=require("os"),util=require("util"),path=require("path"),shelljs=require("shelljs"),mkdirp=require("mkdirp"),temp=require("temp"),zlib=require("zlib"),tarFilterPack=require("./tar-filter-pack"),rimraf=require("rimraf"),fstream=require("fstream"),spawn=require("child_process").spawn,async=require("async"),CombinedStream=require("combined-stream"),npmlog=require("npmlog"),Validator=require("jsonschema").Validator;
(function(){function v(a){this.objectId=F++;this.verbose=!1;this.silent=!0;a&&a.level&&(f.level=a.level,-1!==["warn","error"].indexOf(a.level)&&(this.silent=!1));this.noclean=!1;a&&!0===a.noclean&&(this.noclean=!0);this.nativecmd=!1;a&&!0===a.nativecmd&&(this.nativecmd=!0);this.minify=!0;a&&a.hasOwnProperty("minify")&&(this.minify=a.minify);a&&a.hasOwnProperty("deployscript")&&(this.deployscript=a.deployscript);a&&a.hasOwnProperty("deploy-enyo")&&(this["deploy-enyo"]=a["deploy-enyo"]);a&&a.hasOwnProperty("deploy-lib")&&
(this["deploy-lib"]=a["deploy-lib"]);a&&a.hasOwnProperty("deploy-srcroot")&&(this["deploy-srcroot"]=a["deploy-srcroot"]);this.excludeFiles=[];a&&a.hasOwnProperty("excludefiles")&&(a.excludefiles instanceof Array?this.excludeFiles=a.excludefiles:this.excludeFiles.push(a.excludefiles));this.rom=!1;a&&a.hasOwnProperty("rom")&&(this.rom=a.rom);f.verbose("Xtor Packager id="+this.objectId);this.appCount=0;this.services=[];this.pkgServiceNames=[]}function G(){this.srcDir="";this.dstDirs=[];this.valid=!1;
this.dirName=this.serviceInfo=""}function H(a){f.verbose("loadAppInfo");if(0===this.appCount)return setImmediate(a);var b=path.join(this.appDir,"appinfo.json");fs.readFile(b,function(b,d){try{f.verbose("APPINFO >>"+d+"<<");this.appinfo=JSON.parse(d);if(this.appinfo.onDeviceSource)for(var g in this.appinfo.onDeviceSource){var e=this.appinfo.onDeviceSource[g],h;for(h in w)e=e.replace(h,w[h]);this.appinfo.onDeviceSource[g]=e}setImmediate(a)}catch(l){setImmediate(a,l)}}.bind(this))}function I(a){f.verbose("checkAppInfo");
if(0===this.appCount)return setImmediate(a);f.verbose("checkAppInfo: id: "+this.appinfo.id);var b=path.join(__dirname,"ApplicationDescription.schema");async.waterfall([fs.readFile.bind(this,b,"utf-8"),function(a,b){try{var g=JSON.parse(a),e=g.required;if(e)for(key in g.properties)-1!=e.indexOf(key)&&(g.properties[key].required=!0);b(null,g)}catch(f){b(Error("Invalid JSON Schema for appinfo"))}},function(a,b){try{b(null,(new Validator).validate(this.appinfo,a))}catch(g){f.error(g),b(Error("Invalid JSON Schema"))}}.bind(this)],
function(b,d){if(b)setImmediate(a,b);else{if(d&&0<d.errors.length){var g;g="".concat("Invalid appinfo.json");for(idx in d.errors){g=g.concat("\n");var e=d.errors[idx].property+" "+d.errors[idx].message;-1<e.indexOf("instance.")&&(e=e.substring(9));g=g.concat(e)}return setImmediate(a,Error(g))}f.verbose("APPINFO is valid");setImmediate(a)}})}function J(a){f.verbose("fillAssetsField");if(0===this.appCount)return setImmediate(a);this.appinfo.assets=this.appinfo.assets||[];for(var b in this.appinfo)this.appinfo.hasOwnProperty(b)&&
x[b]&&-1===this.appinfo.assets.indexOf(this.appinfo[b])&&this.appinfo[b]&&this.appinfo.assets.push(this.appinfo[b]);var c=this.originAppDir;b=path.join(this.originAppDir,"resources");var d=[],g=[];try{if(!fs.lstatSync(b).isDirectory())return setImmediate(a,null)}catch(e){if("ENOENT"===e.code)return setImmediate(a,null)}async.series([s.bind(null,b,"appinfo.json",d),function(a){async.forEach(d,function(a,b){fs.readFile(a,function(d,e){try{var f=JSON.parse(e),h=path.dirname(a),p;for(p in f)if(f.hasOwnProperty(p)&&
x[p]&&f[p]){var K=path.join(h,f[p]),y=path.relative(c,K);-1===g.indexOf(y)&&g.push(y)}setImmediate(b,null)}catch(q){setImmediate(b,Error("JSON parsing error for "+a))}})},function(b){setImmediate(a,b)})},function(a){this.appinfo.assets=this.appinfo.assets.concat(g);setImmediate(a,null)}.bind(this)],function(b){setImmediate(a,b)})}function L(a){f.verbose("createTmpDir");this.tempDir=temp.path({prefix:"com.palm.ares.hermes.bdOpenwebOS"})+".d";f.verbose("temp dir = "+this.tempDir);mkdirp(this.tempDir,
a)}function M(a){f.verbose("createAppDir");if(0===this.appCount)return setImmediate(a);this.applicationDir=path.join(this.tempDir,"data/usr/palm/applications",this.appinfo.id);f.verbose("application dir = "+this.applicationDir);mkdirp(this.applicationDir,a)}function N(a){f.verbose("minifyApp");if(0===this.appCount)return setImmediate(a);var b;if(!0===this.minify){var c=!1;this.deployscript&&(b=this.deployscript);if(fs.existsSync(path.join(this.appDir,"package.js"))&&this.appinfo.main&&this.appinfo.main.match(/(\.html|\.htm)$/gi)){regex=
/(<script[^>]*src[ \t]*=[ \t]*['"])[^'"]*\/enyo.js(['"])/;var d=path.join(this.appDir,this.appinfo.main);if(!fs.existsSync(d))return setImmediate(a,Error(this.appinfo.main+" does not exist. please check the file path"));fs.readFileSync(d).toString().match(regex)&&(c=!0,b||(b=path.join(__dirname,"../enyo/tools/deploy.js")))}if(!c&&b)return console.log("Ignore deploy-script because minifying is only for enyo app"),setImmediate(a);f.verbose("minifying tool:",b);if(fs.existsSync(b)){if(!fs.lstatSync(b).isFile()){setImmediate(a,
"ERROR: '"+b+"' is not a valid file path");return}b=[path.resolve(b)];var g,e;this["deploy-srcroot"]||fs.existsSync(path.join(this.appDir,"deploy.json"))||fs.existsSync(path.join(this.appDir,"index.html"))||(c=path.dirname(path.resolve(path.join(this.appDir,this.appinfo.main))),c!==path.basename(path.resolve(this.appDir))&&(console.log("Set source code root directory :",c),this["deploy-srcroot"]=c));c={};d=this["deploy-srcroot"]?path.join(this["deploy-srcroot"],"deploy.json"):path.join(this.appDir,
"deploy.json");if(fs.existsSync(d)){var h=fs.readFileSync(d);try{c=JSON.parse(h),c.enyo&&!this["deploy-lib"]&&(this["deploy-lib"]=path.join(this.appDir,path.join(c.enyo,"../lib")))}catch(l){setImmediate(a,"ERROR: invalid deploy.json ("+path.resolve(d)+")");return}}this["deploy-srcroot"]&&(g=path.relative(path.resolve(this.appDir),path.resolve(this["deploy-srcroot"])),b.push("-s",g),b.push("-o",path.join("deploy",path.basename(this.appDir),g)));this["deploy-enyo"]&&(e=path.relative(path.resolve(this.appDir),
path.resolve(this["deploy-enyo"])),b.push("-e",e));this["deploy-lib"]&&(d=path.relative(path.resolve(this.appDir),path.resolve(this["deploy-lib"])),b.push("-l",d));var m=!1,n=e?e:c.enyo?this["deploy-srcroot"]?path.join(g,c.enyo):c.enyo:"enyo",n=path.resolve(this.appDir,n);this.appinfo.onDeviceSource&&-1!==Object.keys(this.appinfo.onDeviceSource).indexOf("enyo")||!fs.existsSync(n)||fs.existsSync(path.join(n,"minify","package.js"))||(f.verbose("Enyo is already minified..."),m=!0,b.push("-f","enyo",
"-t","enyo"));if(this.appinfo.onDeviceSource)for(var k in this.appinfo.onDeviceSource)g=this.appinfo.onDeviceSource[k],k=k.replace(/[/|\\]/g,path.sep),g=g.replace(/[\\]/g,"/"),-1!==k.indexOf("lib"+path.sep)&&this["deploy-lib"]&&(subFrom=k.substring(k.indexOf("lib"+path.sep)+4),k=path.relative(this.appDir,path.join(path.resolve(this["deploy-lib"]),subFrom)),k=k.replace(/[/|\\]/g,path.sep)),b.push("-f",k,"-t",g);this.appinfo.resolutionIndependent&&(console.log("Enabling resolution-independence..."),
b.push("-ri"));f.verbose("Minifying command...\n","node "+b.join(" ")+"\n");k=spawn("node",b,{cwd:this.appDir});g=function(a){console.log(a.toString())};k.stderr.on("data",g);k.stdout.on("data",g);k.on("exit",function(b){if(0!==b)setImmediate(a,"ERROR: minification failed");else{b=path.join(this.appDir,"deploy",path.basename(this.appDir));var c={},d;for(d in this.appinfo)this.appinfo.hasOwnProperty(d)&&!z[d]&&(c[d]=this.appinfo[d]);fs.writeFileSync(path.join(b,"appinfo.json"),JSON.stringify(c,null,
"\t"));fs.existsSync(path.join(this.appDir,"framework_config.json"))&&shelljs.cp(path.join(this.appDir,"framework_config.json"),b);m&&fs.existsSync(n)&&shelljs.cp("-rf",path.join(n,"*"),path.join(b,"build"));console.log("Packaging minified output: "+b);this.appDir=b;setImmediate(a)}}.bind(this));return}this.deployscript&&setImmediate(a,"Deploy script '"+this.deployscript+"' not found.")}setImmediate(a)}function q(a,b,c){function d(a,b,d,c,g,f){e[b]&&a.push({type:b,basePath:d,relPath:c,isSubPath:g,
indRelPath:f})}function g(a,b,c,e){async.waterfall([fs.readdir.bind(null,a),function(e,h){if(0===e.length)return d(c,"dir",b,path.relative(b,a),!0,null),setImmediate(h);async.forEachSeries(e,function(e,h){var k=path.join(a,e),r=path.relative(b,k);async.waterfall([fs.lstat.bind(null,k),function(a,e){if(a.isSymbolicLink()){try{var h=fs.realpathSync(k)}catch(l){return"ENOENT"===l.code?(f.warn("The file for symbolic link ("+k+") is missing..."),setImmediate(e)):setImmediate(e,l)}var p=fs.readlinkSync(k);
if(-1!==h.indexOf(b))d(c,"symlink",b,r,!0,p);else{h=fs.statSync(k);if(h.isDirectory())return g(k,b,c,e);h.isFile()&&d(c,"file",b,r,!0,null)}}else{if(a.isDirectory())return g(k,b,c,e);a.isFile()&&d(c,"file",b,r,!0,null)}setImmediate(e)}],h)},h)}],function(a){return setImmediate(e,a)})}var e={file:"file",dir:"dir",symlink:"symlink"},h=[];a=path.normalize(path.resolve(a));b=path.normalize(path.resolve(b));async.series([function(b){fs.statSync(a).isFile()?(d(h,"file",path.dirname(a),path.basename(a),
!0,null),setImmediate(b)):g(a,a,h,b)},function(a,b,c){try{async.forEachSeries(a,function(a,c){if(e[a.type]){if(!a.relPath)return f.verbose("copySrcToDst#_copySrcToDst#ignore 'unknown path'"),setImmediate(c);if(a.type===e.dir)return mkdirp.sync(path.join(b,a.relPath)),setImmediate(c);var d=path.dirname(path.join(b,a.relPath));fs.existsSync(d)||mkdirp.sync(d);a.type===e.symlink?a.isSubPath&&a.indRelPath&&(d=path.join(b,a.relPath),fs.existsSync(d)&&fs.lstatSync(d).isSymbolicLink()&&fs.unlinkSync(d),
fs.symlinkSync(a.indRelPath,d,null)):fs.existsSync(path.join(a.basePath,a.relPath))?shelljs.cp("-Rf",path.join(a.basePath,a.relPath),path.join(b,a.relPath,"..")):f.verbose("copySrcToDst#_copySrcToDst#ignore '"+a.relPath+"'");setImmediate(c)}else f.verbose("copySrcToDst#_copySrcToDst#ignore 'unknown file type'("+a.type+")")},function(a){setImmediate(c,a)})}catch(d){setImmediate(c,d)}}.bind(null,h,b)],function(a){c(a)})}function O(a){f.verbose("copyApp");if(0===this.appCount)return setImmediate(a);
this.dataCopyCount++;q(this.appDir,this.applicationDir,a)}function P(a){function b(a,b){var c,h,l=!1;if(path.resolve(a)==path.normalize(a))return l=!0,c=a,b(Error("In appinfo.json, '"+a+"'' path must be relative to the appinfo.json."));c=path.join(this.originAppDir,a);if(0!=path.resolve(c).indexOf(this.originAppDir))return b(Error("In appinfo.json, '"+a+"'' path must be located under app diectory."));if(!fs.existsSync(c))return b(Error("'"+a+"'' does not exist. please check the file path."));0===
path.resolve(c).indexOf(this.originAppDir)?!0===l?(l=path.relative(this.originAppDir,a),h=path.dirname(path.join(this.appDir,l))):h=path.dirname(path.join(this.appDir,a)):(f.verbose("copyAssets # '"+a+"' will be located in app directory"),h=this.appDir);async.series([function(a){fs.existsSync(h)?setImmediate(a):mkdirp(h,a)}],function(a){if(a)return setImmediate(b,a);shelljs.cp("-Rf",c,h);setImmediate(b)})}f.verbose("copyAssets");if(0===this.appCount||path.resolve(this.originAppDir)===path.resolve(this.appDir))return setImmediate(a);
try{async.forEachSeries(this.appinfo.assets,b.bind(this),a)}catch(c){return setImmediate(a,c)}}function Q(a){f.verbose("excludeIpkFileFromApp");this.excludeFiles=this.excludeFiles.concat(["[.]*[.]ipk",".DS_Store"]);setImmediate(a)}function A(a,b,c,d){async.waterfall([fs.readdir.bind(null,c),function(d,e){async.forEach(d,function(d,e){var g=path.join(c,d);async.waterfall([fs.lstat.bind(null,g),function(c,e){var f=!1;b.test(d)&&(f=!0,a.push(g));!f&&c.isDirectory()?A(a,b,g,e):setImmediate(e)}],e)},e)}],
function(a){setImmediate(d,a)})}function R(a){f.verbose("excludeFromApp");var b=[],c=(0===this.appCount?this.excludeFiles:this.excludeFiles.concat(this.appinfo.exclude||[])).map(function(a){return a.replace(/^\./g,"^\\.").replace(/^\*/g,"").replace(/$/g,"$")},this).join("|");async.series([A.bind(this,b,new RegExp(c,"i"),this.tempDir),function(a){try{b.forEach(function(a){shelljs.rm("-rf",a)}),setImmediate(a)}catch(c){setImmediate(a,c)}}],function(b,c){if(b)return setImmediate(a,b);setImmediate(a)})}
function S(a){f.verbose("rewriteAppInfo");if(0===this.appCount)return setImmediate(a);if(!0!==this.minify){var b={},c;for(c in this.appinfo)!this.appinfo.hasOwnProperty(c)||z[c]||T[c]||(b[c]=this.appinfo[c]);fs.writeFileSync(path.join(this.applicationDir,"appinfo.json"),JSON.stringify(b,null,"\t"))}setImmediate(a)}function U(a){f.verbose("rewriteAppJS");if(0===this.appCount)return setImmediate(a);if(!0===this.minify&&this.appinfo.onDeviceSource)try{var b=path.join(this.applicationDir,"build");fs.existsSync(b)&&
fs.readdirSync(b).forEach(function(a){a=path.join(b,a);if(fs.statSync(a).isFile()){for(var c=fs.readFileSync(a,"utf8"),e=/enyo.path.addPath\(.*\)|enyo.depends\(.*[\s\S]*\)/g;null!=(result=e.exec(c));)c=c.replace(result[0],result[0].replace(/[\\]/g,"/"));fs.writeFileSync(a,c,"utf8")}})}catch(c){setImmediate(a,c)}setImmediate(a)}function V(a){f.verbose("rewriteSourcePaths");if(0===this.appCount)return setImmediate(a);if(!0===this.minify){if(this.appinfo.onDeviceSource){var b=(this.appinfo.additionalHtmlFiles||
[]).concat(this.appinfo.main),c;for(c in b){var d=b[c];try{var g=path.join(this.applicationDir,d),e=fs.readFileSync(g,"utf8"),h;for(h in this.appinfo.onDeviceSource){var l=this.appinfo.onDeviceSource[h],m=new RegExp("(<link[^>]*href[ \t]*=[ \t]*['\"][ \t]*)"+h),e=e.replace(m,"$1"+l),m=new RegExp("(<script[^>]*src[ \t]*=[ \t]*['\"][ \t]*)"+h),e=e.replace(m,"$1"+l);"enyo"==h&&(m=/(<link[^>]*href[ \t]*=[ \t]*['"])[^'"]*build\/enyo.css(['"])/,e=e.replace(m,"$1"+l+"/enyo.css$2"),m=/(<script[^>]*src[ \t]*=[ \t]*['"])[^'"]*build\/enyo.js(['"])/,
e=e.replace(m,"$1"+l+"/enyo.js$2"))}fs.writeFileSync(g,e,"utf8")}catch(n){setImmediate(a,n)}}}}else for(c in b=(this.appinfo.additionalHtmlFiles||[]).concat(this.appinfo.main),b){d=b[c];try{g=path.join(this.applicationDir,d),e=fs.readFileSync(g,"utf8"),m=/(<link[^>]*href[ \t]*=[ \t]*['"])[^'"]*build\/enyo.css(['"]).*(\/>|<\/link>)/,e=e.replace(m,""),m=/(<script[^>]*src[ \t]*=[ \t]*['"])[^'"]*build\/enyo.js(['"]).*(\/>|<\/script>)/,e=e.replace(m,""),fs.writeFileSync(g,e,"utf8")}catch(k){setImmediate(a,
k)}}setImmediate(a)}function W(a){f.verbose("createPackageDir");if(0===this.appCount)return setImmediate(a);this.rom?setImmediate(a):(this.packageDir=path.join(this.tempDir,"data/usr/palm/packages",this.appinfo.id),f.verbose("package dir = "+this.packageDir),mkdirp(this.packageDir,a))}function X(a){f.verbose("fillPackageDir");if(0===this.appCount)return setImmediate(a);if(this.rom)setImmediate(a);else if(this.pkgDir)shelljs.cp("-Rf",path.join(this.pkgDir,"packageinfo.json"),this.packageDir),setImmediate(a);
else{var b=JSON.stringify({app:this.appinfo.id,id:this.appinfo.id,loc_name:this.appinfo.title,package_format_version:this.appinfo.uiRevision,vendor:this.appinfo.vendor,version:this.appinfo.version||"1.0.0"},null,2)+"\n";f.verbose("Generating package.json: "+b);fs.writeFile(path.join(this.packageDir,"packageinfo.json"),b,a)}}function Y(a,b){f.verbose("loadPackageProperties");var c=this;c.packageProperties={};async.forEach(a,function(a,b){var e=path.join(a,"package.properties");fs.existsSync(e)?fs.readFile(e,
function(a,d){try{f.verbose("PACKAGE PROPERTIES >>"+d+"<<");var e=d.toString().split("\n"),n,k;for(k in e)if(0==e[k].indexOf("filemode.")){n=e[k].indexOf("=");var r=e[k].substr(n+1).trim(),q=e[k].slice(9,n).trim();r.split(",").forEach(function(a){a=a.replace(/\\/g,"/").trim();var b=a.lastIndexOf("/");a=-1!==b?a.substr(b+1):a;c.packageProperties[a]=q}.bind(this))}setImmediate(b)}catch(p){setImmediate(b,p)}}):setImmediate(b)},function(a){c.excludeFiles=c.excludeFiles.concat(["package.properties"]);
setImmediate(b,a)})}function Z(a,b,c,d){this.rom?q(path.join(this.tempDir,"data"),a,d):async.series([$.bind(this,b,c),aa.bind(this,"data"),B.bind(this,"data","data.tar.gz"),ba.bind(this),ca.bind(this),B.bind(this,"ctrl","control.tar.gz"),da.bind(this),ea.bind(this,a),fa.bind(this,a)],function(a,b){a?setImmediate(d,a):setImmediate(d)})}function $(a,b,c){f.verbose("decidePkgName");this.pkg=0!==this.appCount?{name:a||this.appinfo.id,version:b||this.appinfo.version}:0<this.services.length?{name:a||this.services[0].serviceInfo.id||
this.services[0].serviceInfo.services[0].name,version:b||"1.0.0"}:{name:a||"unknown",version:b||"1.0.0"};setImmediate(c)}function aa(a,b){function c(a,b){fs.lstat(a,function(d,g){var f=g.size;!d&&g.isDirectory()?fs.readdir(a,function(d,g){if(d)return b(d);async.forEach(g,function(b,d){c(path.join(a,b),function(a,b){f+=b;d(a)})},function(a){b(a,f)})}):b(d,f)})}f.verbose("getFileSize");var d=this,g=path.join(this.tempDir,a);async.waterfall([c.bind(this,g)],function(a,c){!a&&c&&(f.verbose("getFileSize#Installed-Size:",
c),d.size=c);setImmediate(b,a)})}function ba(a){f.verbose("createCtrlDir");this.ctrlDir=path.join(this.tempDir,"ctrl");f.verbose("ctrl dir = "+this.ctrlDir);mkdirp(this.ctrlDir,a)}function ca(a){f.verbose("createControlFile");var b=["Package: "+this.pkg.name,"Version: "+this.pkg.version,"Section: misc","Priority: optional","Architecture: all","Installed-Size: "+(this.size||1234),"Maintainer: N/A <nobody@example.com>","Description: This is a webOS application.","webOS-Package-Format-Version: 2","webOS-Packager-Version: x.y.x",
""];fs.writeFile(path.join(this.ctrlDir,"control"),b.join("\n"),a)}function da(a){f.verbose("createDebianBinary");fs.writeFile(path.join(this.tempDir,"debian-binary"),"2.0\n",a)}function B(a,b,c){a=path.join(this.tempDir,a);f.verbose("makeTgz "+b+" from "+a);var d=String(a).length,g=this.pkgServiceNames;fstream.Reader({path:a,type:"Directory",filter:function(a){"Directory"===a.props.type&&(maskingBits=201,-1!==g.indexOf(a.props.basename)&&(maskingBits=219),a.props.mode|=a.props.mode>>>2&maskingBits);
return!0}}).pipe(tarFilterPack({noProprietary:!0,pathFilter:function(a){return"."+a.slice(d)},permission:this.packageProperties})).pipe(zlib.createGzip()).pipe(fstream.Writer(path.join(this.tempDir,b))).on("close",c).on("error",c)}function ea(a,b){f.verbose("removeExistingIpk");if(0===this.appCount)return setImmediate(b);var c=path.join(a,this.appinfo.id+"_"+this.appinfo.version+"_all.ipk");fs.exists(c,function(a){a?fs.unlink(c,b):setImmediate(b)})}function t(a,b){return String(a+"                                     ").slice(0,
b)}function C(a,b){var c=Math.floor(Date.now()/1E3);return t(a,16)+t(c,12)+"0     0     100644  "+t(b,10)+"`\n"}function fa(a,b){var c=this.pkg.name,c=this.pkg.version?c.concat("_"+this.pkg.version+"_all.ipk"):c.concat(".ipk");this.ipk=path.join(a,c);f.verbose("makeIpk in dir "+a+" file "+c);if(this.nativecmd)shelljs.cd(this.tempDir),shelljs.exec("ar -q "+this.ipk+" debian-binary control.tar.gz data.tar.gz",{silent:this.silent}),console.log("Creating package "+c+" in "+a),setImmediate(b);else{var d=
CombinedStream.create(),g=C("debian-binary",4)+"2.0\n",e=this;d.append("!<arch>\n"+g);g=fstream.Writer(this.ipk);["control.tar.gz","data.tar.gz"].forEach(function(a){var b=path.join(e.tempDir,a),c=fstream.Reader({path:b,type:"File"}),b=fs.statSync(b);d.append(C(a,b.size));d.append(c);0!==b.size%2&&(f.verbose("Adding a filler for file "+a),d.append("\n"))},this);d.pipe(g);g.on("close",function(){console.log("Creating package "+c+" in "+a);setImmediate(b)});g.on("error",b)}}function ga(a){f.verbose("cleanupTmpDir");
this.noclean?(console.log("Skipping removal of  "+this.tempDir),setImmediate(a)):rimraf(this.tempDir,function(b){f.verbose("cleanup(): removed "+this.tempDir);setImmediate(a,b)}.bind(this))}function ha(a,b,c){f.verbose("checkDirectory: "+b);if(fs.existsSync(b))if(fs.statSync(b).isDirectory()){b=fs.realpathSync(b);if(a.force)return c();if(fs.existsSync(path.join(b,"appinfo.json")))this.appCount++,f.verbose("FOUND appinfo.json, appCount "+this.appCount),1<this.appCount?c("ERROR: only one application is supported"):
(this.originAppDir=this.appDir=b,c());else if(fs.existsSync(path.join(b,"packageinfo.json")))this.pkgDir=b,c();else if(fs.existsSync(path.join(b,"services.json")))this.svcDir=this.svcDir||[],this.svcDir=this.svcDir.concat(b),c();else if(fs.existsSync(path.join(b,"account-templates.json")))c("ERROR: account directory support is not yet implemented");else{var d=[];this.svcDir=this.svcDir||[];this.svcDir=this.svcDir.concat(b);D.call(this,d,function(a){0<d.length?c():c("ERROR: '"+b+"' has no webOS json files")})}}else c("ERROR: '"+
b+"' is not a directory");else c("ERROR: directory '"+b+"' does not exist")}function D(a,b){var c=[].concat(this.svcDir||this.originAppDir||[]),d=[];if(0===c.length)return setImmediate(b);async.forEach(c,function(b,c){s(b,"services.json",d,function(b){if(b)return setImmediate(c,b);d.forEach(function(b){var c=new G;c.srcDir=path.dirname(b);c.dirName=path.basename(c.srcDir);a.push(c)});setImmediate(c,b)})},function(a){setImmediate(b,a)})}function s(a,b,c,d){async.waterfall([fs.readdir.bind(null,a),
function(d,e){async.forEach(d,function(d,e){var f=path.join(a,d);async.waterfall([fs.lstat.bind(null,f),function(a,e){a.isFile()?(d===b&&c.push(f),e()):a.isDirectory()?s(f,b,c,e):e()}],e)},e)}],function(a){d(a)})}function ia(a){f.verbose("loadServiceInfo");for(idx in this.services){var b=path.join(this.services[idx].srcDir,"services.json");try{var c=fs.readFileSync(b);this.services[idx].serviceInfo=JSON.parse(c);this.services[idx].valid=!0}catch(d){return setImmediate(a,d)}}f.verbose("num of serviceInfo: "+
this.services.length);setImmediate(a)}function ja(a){f.verbose("checkServiceInfo");if(0===this.appCount)return setImmediate(a);var b=this.appinfo.id;this.services.forEach(function(c){!1!==c.valid&&u(c.serviceInfo).forEach(function(c){if(-1===c.indexOf(b+"."))return setImmediate(a,Error('service name "'+c+'" must be subdomain of app id "'+b+'"'))}.bind(this))}.bind(this));setImmediate(a)}function ka(a){f.verbose("createServiceDir");this.services.forEach(function(b){!1!==b.valid&&u(b.serviceInfo).forEach(function(c){c=
path.join(this.tempDir,"data/usr/palm/services",c);b.dstDirs.push(c);try{mkdirp.sync(c)}catch(d){return setImmediate(a,d)}}.bind(this))}.bind(this));setImmediate(a)}function la(a){f.verbose("copyService");var b=this.services.filter(function(a){return a.valid});try{async.forEachSeries(b,function(a,b){async.forEach(a.dstDirs,function(b,c){this.dataCopyCount++;q(a.srcDir,b,c)},b)},a)}catch(c){setImmediate(a,c)}}function ma(a){f.verbose("addServiceInPkgInfo");if(0===this.appCount)return setImmediate(a);
if(this.rom)setImmediate(a);else{var b=path.join(this.packageDir,"packageinfo.json"),c;try{var d=fs.readFileSync(b),g=0;f.verbose("PACKAGEINFO >>"+d+"<<");c=JSON.parse(d)}catch(e){console.error(e),setImmediate(a,e)}this.services.filter(function(a){return a.valid}).forEach(function(a){u(a.serviceInfo).forEach(function(a){this.pkgServiceNames.push(a);g++}.bind(this))}.bind(this));0<g?(c.services=this.pkgServiceNames,d=JSON.stringify(c,null,2)+"\n",f.verbose("Modified package.json: "+d),fs.writeFile(path.join(this.packageDir,
"packageinfo.json"),d,a)):setImmediate(a)}}function na(a){f.verbose("removeServiceFromAppDir");if(0===this.appCount)return setImmediate(a);var b=this.applicationDir,c=!1,d=fs.readdirSync(b);-1!==d.indexOf("services")&&(b=path.join(this.applicationDir,"services"),fs.statSync(b).isDirectory()&&(c=!0));if(!0===c)try{shelljs.rm("-rf",b)}catch(g){console.log("ERROR:"+g)}else for(var e in this.services){var h=this.services[e].dirName;d.forEach(function(a){if(h===a)try{var b=path.join(this.applicationDir,
this.services[e].dirName);shelljs.rm("-rf",b)}catch(c){console.log("ERROR:"+c)}},this)}setImmediate(a)}function oa(a,b,c){f.verbose("copyData ** Only run when force packaging");if(b&&0===this.dataCopyCount){var d=path.join(this.tempDir,"data");async.forEachSeries(a,function(a,b){q(a,d,b)},function(a,b){setImmediate(c,a)}.bind(this))}else return setImmediate(c)}function u(a){var b=[];"id"===pa?b=[a.id]:a.services&&(b=(a.services instanceof Array?a.services:[a.services]).map(function(a){return a.name}));
return b}function qa(a,b){this.oldmask=process.umask(a);setImmediate(b)}function ra(a){this.oldmask&&process.umask(this.oldmask);setImmediate(a)}var f=npmlog;f.heading="packager";f.level="warn";var pa="id",w={$frameworks:"/usr/palm/frameworks","$enyo-framework":"/usr/palm/frameworks/enyo"},z={onDeviceSource:!0,additionalHtmlFiles:!0,assets:!0,exclude:!0},T={containerJS:!0,containerCSS:!0},x={main:!0,icon:!0,largeIcon:!0,bgImage:!0,splashBackground:!0,imageForRecents:!0},E={};"undefined"!==typeof module&&
module.exports&&(module.exports=E);var F=0;E.Packager=v;v.prototype={checkInputDirectories:function(a,b,c){f.verbose("checkInputDirectories: "+a);async.forEachSeries(a,ha.bind(this,b),function(a,f){a?setImmediate(c,a):b.force||0!==this.appCount?setImmediate(c):setImmediate(c,"ERROR: At least an APP_DIR must be specified")}.bind(this))},generatePackage:function(a,b,c,d){f.verbose("generatePackage: from "+a);this.dataCopyCount=0;async.series([this.checkInputDirectories.bind(this,a,c),qa.bind(this,0),
H.bind(this),I.bind(this),J.bind(this),L.bind(this),M.bind(this),N.bind(this),P.bind(this),O.bind(this),Q.bind(this),S.bind(this),U.bind(this),V.bind(this),W.bind(this),X.bind(this),D.bind(this,this.services),ia.bind(this),ja.bind(this),ka.bind(this),la.bind(this),ma.bind(this),na.bind(this),oa.bind(this,a,c.force),Y.bind(this,a),R.bind(this),Z.bind(this,b,c.pkgname,c.pkgversion),ra.bind(this),ga.bind(this)],function(a,b){a?setImmediate(d,a):setImmediate(d,null,{ipk:this.ipk,msg:"Success"})}.bind(this))}}})();
