var fs=require("fs"),path=require("path"),log=require("npmlog"),nopt=require("nopt"),async=require("async"),ipkg=require("./../lib/ipkg-tools"),versionTool=require("./../lib/version-tools"),cliControl=require("./../lib/cli-control"),help=require("./../lib/helpFormat"),util=require("./../lib/utility"),sdkenv=require("./../lib/sdkenv"),processName=path.basename(process.argv[1]).replace(/.js/,"");process.on("uncaughtException",function(a){log.error("uncaughtException",a.toString());cliControl.end(-1)});
2===process.argv.length&&process.argv.splice(2,0,"--help");var knownOpts={version:Boolean,help:Boolean,open:Boolean,level:"silly verbose info http warn error".split(" ")},shortHands={V:["--version"],h:["--help"],o:["--open"],v:["--level","verbose"]},argv=nopt(knownOpts,shortHands,process.argv,2);log.heading=processName;log.level=argv.level||"warn";ipkg.launcher.log.level=log.level;argv.help&&(showUsage(),cliControl.end());log.verbose("argv",argv);var op;
argv.version?versionTool.showVersionAndExit():op=runServer;op&&versionTool.checkNodeVersion(function(a){op(finish)});function showUsage(){var a=["","NAME",help.format(processName+" - Runs a local web server based on path"),"","SYNOPSIS",help.format(processName+" [OPTION...] <APP_DIR>"),"","OPTION",help.format("-o, --open","Open localhost url with a web browser"),"",help.format("-h, --help","Display this help"),help.format("-V, --version","Display version info"),""];help.print(a)}
function runServer(){var a=argv.argv.remain.splice(0,1).join("");if(!a)return finish("Please check the app directory path for web server");var a=fs.realpathSync(a),b,c="";async.waterfall([util.runServer.bind(util,a,0,function(a,d){"@@ARES_CLOSE@@"===a?(d.status(200).send(),b=setTimeout(function(){cliControl.end()},2E3)):"@@GET_URL@@"===a&&(clearTimeout(b),d.status(200).send(c))}),function(a,b){if(a&&a.port){c="http://localhost:"+a.port;var f=c+"/ares_cli/ares.html";console.log("Local server running on "+
c)}if(argv.open&&a.port){var e=new sdkenv.Env;async.series([e.getEnvValue.bind(e,"BROWSER")],function(a,c){if(a)return b(a);util.openBrowser(f,c[0])})}}],finish)}function finish(a,b){a?(log.error(a),log.verbose(a.stack),cliControl.end(-1)):(b&&b.msg&&console.log(b.msg),cliControl.end())}process.on("uncaughtException",function(a){console.log("Caught exception: "+a)});
