var fs=require("fs"),url=require("url"),util=require("util"),async=require("async"),path=require("path"),log=require("npmlog"),vm=require("vm"),shelljs=require("shelljs"),mkdirp=require("mkdirp"),nopt=require("nopt"),sprintf=require("sprintf-js").sprintf,prjgen=require("ares-generator"),versionTool=require("./../lib/version-tools"),cliControl=require("./../lib/cli-control"),help=require("./../lib/helpFormat"),errMsgHdlr=require("./../lib/error-handler"),cliData=require("./../lib/cli-appdata").create(".ares");
shelljs.config.fatal=!0;var processName=path.basename(process.argv[1]).replace(/.js/,"");process.on("uncaughtException",function(b){log.error("*** "+processName+": "+b.toString());log.info("uncaughtException",b.stack);cliControl.end(-1)});2===process.argv.length&&process.argv.splice(2,0,"--help");
var TMPL_FILE=path.resolve(path.join(path.dirname(process.argv[1]),"../ide-plugin.json")),DEF_BP_FILE=path.join(cliData.getPath(),"baseBpVer.json"),DEF_BP_VER="2.5",DEF_SRC_TYPE="template",DEF_SVC_NAME="com.yourdomain.app.service",VER_FILES={moonstone:"lib/moonstone/version.js",garnet:"lib/garnet/version.js",sunstone:"lib/sunstone/version.js"},idx;
(-1!==(idx=process.argv.indexOf("--list"))||-1!==(idx=process.argv.indexOf("-l")))&&process.argv[idx+1]&&process.argv[idx+1].toString().match(/^-/)&&process.argv.splice(idx+1,0,DEF_SRC_TYPE);
var knownOpts={help:Boolean,"hidden-help":Boolean,version:Boolean,list:String,overwrite:Boolean,servicename:String,template:[String,Array],property:[String,Array],onDevice:String,initialize:Boolean,"default-enyo":String,level:"silly verbose info http warn error".split(" ")},shortHands={h:"--help",hh:["--hidden-help"],V:"--version",l:"--list",f:"--overwrite",t:"--template",p:"--property",s:"--servicename",D:"--onDevice",de:"--default-enyo",v:["--level","verbose"]},argv=nopt(knownOpts,shortHands,process.argv,
2);log.heading=processName;log.level=argv.level||"warn";if(argv.help||argv["hidden-help"])showUsage(argv["hidden-help"]),cliControl.end();var op;argv.close?op=close:argv.version?versionTool.showVersionAndExit():op=argv["default-enyo"]?savDefVer:argv.list||argv["default-enyo"]?list:argv.initialize?initialize:generate;
var options={overwrite:argv.overwrite,tmplNames:argv.template||[],listType:argv.list,appInfoProps:argv.property||[],svcName:argv.servicename,bpVer:argv.onDevice,defBpVer:argv["default-enyo"],dstPath:argv.argv.remain[0]};op&&versionTool.checkNodeVersion(function(b){op(finish)});
function showUsage(b){var a=["","NAME",help.format(processName+" - Create webOS app projects from templates"),"","SYNOPSIS",help.format(processName+" [OPTION...] <APP_DIR>"),help.format("\t APP_DIR is the application directory. It will be created if it does not exist."),"","OPTION",help.format("-t,--template <TEMPLATE>","specify TEMPLATE to use"),help.format("","TEMPLATE can be listed via "+processName+" --list, -l"),"",help.format("-l, --list <TYPE>"),help.format("\t List the available templates corresponding with TYPE [default: "+
DEF_SRC_TYPE+"]"),help.format("\t Available TYPE is 'template', 'webosService', 'appinfo'"),"",help.format("-p, --property <PROPERTY>","Set the properties of appinfo.json"),help.format("\t PROPERTY can be one of the following forms"),help.format("win32","\t (e.g.) -p \"{'id': 'com.examples.helloworld', 'version':'1.0.0', 'type':'web'}\""),help.format(["linux","darwin"],'\t (e.g.) -p \'{"id": "com.examples.helloworld", "version":"1.0.0", "type":"web"}\''),help.format('\t (e.g.) -p "id=com.examples.helloworld" -p "version=1.0.0" -p "type=web"'),
"",help.format("-D, --onDevice <ENYO-VERSION>"),help.format("\t ENYO-VERSION is enyo framework version to use"),help.format("\t This option is applied to 'enyoVersion', 'onDeviceSource' field in appinfo.json"),"",help.format("-s, --servicename <SERVICENAME>","Set the servicename for webOS Service"),help.format('\t (e.g.) -s "com.examples.helloworld.service"'),"",help.format("-f, --overwrite","Overwrite existing files [boolean]"),"",help.format("-de, --default-enyo <ENYO-VERSION>"),help.format("\t Set default enyo framework version in the templates"),
"",help.format("--level <LEVEL>","Tracing LEVEL is one of 'silly', 'verbose', 'info', 'http', 'warn', 'error' [warn]"),help.format("-h, --help","Display this help"),help.format("-V, --version","Display version info"),"","DESCRIPTION","",help.format("PROPERTY defines properties to be used during generation."),help.format('Properties can be specified as key-value pairs of the form "key=value"'),help.format('or as JSON objects of the form \'{"key1":"value1", "key2":"value2", ...}\'.'),help.format("Surrounding quotes are required in both cases."),
"","EXAMPLES","","# Create an app with id 'com.domain.app'",processName+' -t bootplate-web -p "id=com.domain.app" ~/projects/app',"","# Create an webOS service named 'com.domain.app.service'",processName+" -t webos-service -s com.domain.app.service ~/projects/service",""],c=["","EXTRA-OPTION",help.format("--initialize","Initialize ares-generate command."),help.format("","Make copies of bootplate templates in CLI data directory"),"EXAMPLES","","# Initialize ares-generate command",processName+" --initialize",
""];help.print(a);b&&help.print(c)}function initialize(){log.info("initialize");async.waterfall([_getTransMaps.bind(this),_copyTempl.bind(this,!0),function(b,a){_rmDefVer(a)}],function(b){finish(b,{msg:"Success"})})}function savDefVer(){log.info("savDefVer");async.waterfall([_getTransMaps.bind(this),_loadTemplConf.bind(this),_checkOptions.bind(this),_savDefVer.bind(this)],function(b){finish(b,{msg:"Success"})})}
function list(){log.info("list");async.waterfall([_getTransMaps.bind(this),_loadTemplConf.bind(this),_checkOptions.bind(this),function(b,a){"true"==b&&(b=DEF_SRC_TYPE);this.tmplConf.sources.forEach(function(a){a.type===b&&console.log(sprintf("%-40s\t%-10s\t%s %s",a.id,a.version,a.description,a.isDefault?"(default)":""))});setImmediate(a)}.bind(this,options.listType)],function(b){finish(b)})}
function generate(){log.info("generate");var b=this;async.waterfall([_getTransMaps.bind(b),_copyTempl.bind(b,!1),_loadTemplConf.bind(b),_checkOptions.bind(b),_substParams.bind(b),function(a,c,e){log.silly("_genApp#substitutions:",c);b.tmplConf.level=log.level;async.waterfall([function(a){new prjgen.Generator(this.tmplConf,a)},function(f,b){console.log("Generating "+a.tmplNames.join(",")+" in "+path.resolve(a.dstPath));f.generate(a.tmplNames,c,a.dstPath,a,b)}],function(a){e(a)})}.bind(b,options)],
function(a){finish(a,{msg:"Success"})})}function finish(b,a){log.info("finish():","err:",b);b?(log.error(processName+": "+b.toString()),log.verbose(b.stack),cliControl.end(-1)):(a&&a.msg&&console.log(a.msg),cliControl.end())}
function _loadTemplConf(b,a){var c=this;c.tmplInfos={};async.waterfall([fs.readFile.bind(fs,TMPL_FILE,"utf8"),function(a,f){var d;try{a=a.replace(/@PLUGINDIR@/g,path.dirname(TMPL_FILE)).replace(/\\/g,"/"),b.forEach(function(b){a=a.replace(new RegExp(b.from,"g"),b.to).replace(/\\/g,"/")}),d=JSON.parse(a),c.tmplConf=d.services[1]}catch(g){throw"Improper JSON: "+a;}setImmediate(f)}.bind(c),function(a){async.forEachSeries(c.tmplConf.sources,function(a,c){var g=[];if(a.files){a.files.forEach(function(a){g=
g.concat(a.url||[]);if(a.symlink){var b=Object.keys(a.symlink).map(function(b){return a.symlink[b]});g=g.concat(b)}});var e=!1;g.forEach(function(c){e||b.forEach(function(b){0===c.indexOf(b.to)&&(a.version=b.version,e=!0)})})}c()},function(b){setImmediate(a,b)})}.bind(c),function(a){async.forEachSeries(c.tmplConf.sources,function(a,b){c.tmplInfos[a.id]={type:a.type,class:a.class,version:a.version,isDefault:a.isDefault,onDevice:a.onDevice};b()},function(b){setImmediate(a,b)})}.bind(c),function(a){async.forEachSeries(c.tmplConf.sources,
function(a,b){if(options.bpVer){if(1<(options.bpVer.match(/\./g)||[]).length){var g=options.bpVer.split(".");options.bpVer=g[0]+"."+g[1];log.warn("Changing --onDevice value to "+options.bpVer)}0<(options.bpVer.match(/\-/g)||[]).length&&(options.bpVer=options.bpVer.split("-")[0],log.warn("Changing --onDevice value to "+options.bpVer))}if(a.class){var e;fs.existsSync(DEF_BP_FILE)&&(e=fs.readFileSync(DEF_BP_FILE,"utf8"));g=a.class+"-"+(options.bpVer||e||a.version);a.deps=a.deps||[];a.deps.push(g);c.tmplInfos.hasOwnProperty(g)&&
(a.version=c.tmplInfos[g].version)}b()},function(b){setImmediate(a,b)})}.bind(c)],function(b){setImmediate(a,b)})}function _getEnyoVersion(b){var a=fs.readFileSync(b);vm.runInThisContext("var enyo={}; enyo.version=new Object(); enyo.mixin=function(){};"+a,b);var c;if("object"===typeof enyo.version&&enyo.version!={})for(key in enyo.version)if("string"===typeof enyo.version[key]){c=enyo.version[key];break}return c}
function _getTransMaps(b){var a=path.join(path.dirname(TMPL_FILE),"templates"),c=[],e=cliData.getPath();async.waterfall([fs.readdir.bind(this,a),function(b,d){b.forEach(function(b){b=path.join(a,b);for(key in VER_FILES){var d=path.join(b,VER_FILES[key]);if(fs.existsSync(d))try{var f=_getEnyoVersion(d);log.silly("Found:",d,", version:",f);c.push({from:b.replace(/\\/g,"/")+"/",to:path.join(e,"templates",f,"bootplate-"+key).replace(/\\/g,"/")+"/",version:f});break}catch(m){console.error("err:",m)}}});
d()}],function(a){setImmediate(b,a,c)})}function _copyTempl(b,a,c){async.forEachSeries(a,function(a,c){var d=path.relative(cliData.getPath(),a.to);b&&fs.existsSync(a.to)&&cliData.remove(d);fs.existsSync(a.to)||(console.log("Initializing template directories. ("+path.basename(a.from)+")"),console.log("Please wait for a while..."),cliData.put(path.join(a.from,"*"),d));c()},function(b){setImmediate(c,b,a)})}
function _substParams(b){log.info("_substitution");var a=[];async.series([function(b){var e={fileRegexp:"appinfo.json"},f={};options.appInfoProps.forEach(function(a){var b;b=a;var c=/^['|"](.)*['|"]$/;c.test(b)&&(b=b.substring(1,a.length-1));c=/^{(.)*}$/;b=c.test(b)?-1===b.indexOf('"')?b.replace(/\s*"/g,"").replace(/\s*'/g,"").replace("{",'{"').replace("}",'"}').replace(/\s*,\s*/g,'","').replace(/\s*:\s*/g,'":"'):b.replace(/\s*'/g,'"'):a;a:{try{JSON.parse(b)}catch(e){c=!1;break a}c=!0}c?f=JSON.parse(b):
(b=f,a=a.split("="),2==a.length&&(b[a[0]]=a[1],log.info("Inserting property "+a[0]+" = "+a[1])))});e.json=f;e.add={};for(key in f)e.add[key]=!0;a.push(e);setImmediate(b)}.bind(this),function(b){var e;fs.existsSync(DEF_BP_FILE)&&(e=fs.readFileSync(DEF_BP_FILE,"utf8"));var f={fileRegexp:"\\.(js|json|c|cpp|cc|css|less|mm|h|hpp|hh|html|htm|md|txt|sh|bat|cmd|xml|dtd|php|java|rb|py)$"};f.regexp={"@ENYO-VERSION@":options.bpVer||e||DEF_BP_VER,"@SERVICE-NAME@":options.svcName||DEF_SVC_NAME};a.push(f);setImmediate(b)}.bind(this)],
function(c){setImmediate(b,null,a)})}
function _checkOptions(b){var a=this,c=0,e=0,f=0,d=[],g=[],l=[],k=options.dstPath?path.resolve(options.dstPath):"";async.series([function(b){if(0===options.tmplNames.length)for(tmplName in a.tmplInfos)if(a.tmplInfos[tmplName].isDefault){options.tmplNames.push(tmplName);break}options.tmplNames&&options.tmplNames.forEach(function(h){if(!a.tmplInfos.hasOwnProperty(h))return b(Error("Please check the template name"));a.tmplInfos[h].type.match(/template/i)?(c++,d.push(h)):a.tmplInfos[h].type.match(/Service/i)?
(e++,g.push(h)):(f++,l.push(h))});setImmediate(b)}.bind(a),function(a){if(!/^[a-zA-Z0-9\.\_\-]*$/.test(path.basename(k)))return a(Error("Not available AppDir name"));setImmediate(a)}.bind(a),function(b){var d=!1;0<e&&(0<c||fs.existsSync(path.join(k,"appinfo.json")))&&(d=!0);async.series([function(b){d?async.forEachSeries(a.tmplConf.sources,function(a,b){-1!==g.indexOf(a.id)&&(a.files[0].prefixToAdd="services/"+a.id);b()},function(a){setImmediate(b,a)}):setImmediate(b)}.bind(a)],function(a){setImmediate(b,
a)})}.bind(a),function(a){fs.existsSync(DEF_BP_FILE)||fs.writeFileSync(DEF_BP_FILE,DEF_BP_VER,"utf8");setImmediate(a)}.bind(a),function(b){var c=[];for(tmplName in a.tmplInfos)if("bootplate"===a.tmplInfos[tmplName].type&&!0===a.tmplInfos[tmplName].onDevice){var d=a.tmplInfos[tmplName].version;1<(d.match(/\./g)||[]).length&&(d=d.split("."),d=d[0]+"."+d[1]);0<(d.match(/\-/g)||[]).length&&(d=d.split("-")[0]);c.push(d)}if(options.bpVer){if(1>(options.bpVer.match(/\./g)||[]).length)return b(Error("'--onDevice' convention should be like 'MAJAR.MINOR'. (eg) "+
DEF_BP_VER));if(-1===c.indexOf(options.bpVer))return b(Error("'--onDevice' value should be one of ["+c.join(", ")+"]"))}setImmediate(b)}.bind(a)],function(a){setImmediate(b,a)})}
function _savDefVer(b){var a=this;async.series([function(b){var e="true"==options.defBpVer?DEF_BP_VER:options.defBpVer,f=[];for(tmplName in a.tmplInfos)if("bootplate"===a.tmplInfos[tmplName].type&&!0===a.tmplInfos[tmplName].onDevice){var d=a.tmplInfos[tmplName].version;1<(d.match(/\./g)||[]).length&&(d=d.split("."),d=d[0]+"."+d[1]);0<(d.match(/\-/g)||[]).length&&(d=d.split("-")[0]);f.push(d)}if(-1===f.indexOf(e))return b(Error("'--default-enyo' value should be one of ["+f.join(", ")+"]"));console.log("Setting default enyo framework version ("+
e+") for enyo based templates...");fs.writeFileSync(DEF_BP_FILE,e,"utf8");setImmediate(b)}.bind(a)],function(a){setImmediate(b,a)})}function _rmDefVer(b){fs.existsSync(DEF_BP_FILE)?fs.unlink(DEF_BP_FILE,b):setImmediate(b)};
